define(["core","tpl","biz/member/cart","biz/plugin/diyform"],function(n,s,i,e){var c={goodsid:0,goods:[],option:!1,specs:[],options:[],params:{titles:"",optionthumb:"",split:";",option:!1,total:1,optionid:0,onSelected:!1,onConfirm:!1,autoClose:!0},open:function(e){if(c.params=$.extend(c.params,e||{}),c.goodsid!=e.goodsid||e.refresh){c.specs=[],c.options=[],c.option=!1,c.params.optionid=0,c.goodsid=e.goodsid;var i={id:e.goodsid};e.liveid&&(i.liveid=e.liveid),e.cangift&&(i.cangift=e.cangift),n.json("goods/picker",i,function(i){if(0!=i.status){if(c.followtip="",c.followurl="",2==i.status)return c.followtip=i.result.followtip,c.followurl=i.result.followurl,void c.show();if(4==i.status)return c.followtip=0,c.needlogin=1,c.endtime=i.result.endtime||0,c.imgcode=i.result.imgcode||0,void c.show();if(3==i.status)return c.followtip=0,c.needlogin=0,c.mustbind=1,c.endtime=i.result.endtime||0,c.imgcode=i.result.imgcode||0,void c.show();if(5==i.status)return FoxUI.toast.show(i.result.message),void(c.goodsid="");var t=window.screen.width*window.devicePixelRatio,o=window.screen.height*window.devicePixelRatio;i.result.width=t,i.result.height=o,c.containerHTML=s("option-picker",i.result),c.goods=i.result.goods,c.specs=i.result.specs,c.options=i.result.options,c.seckillinfo=i.result.seckillinfo,""==c.goods.unit&&(c.goods.unit="件"),c.needlogin=0,c.followtip=0,c.mustbind=0,c.show(),""!=e.action&&null!=e.action||(0<i.result.goods.giftid?$(".cartbtn").hide():$(".cartbtn").show(),$(".confirmbtn").hide(),$(".buybtn").show())}else FoxUI.toast.show("未找到商品!")},!0,!1)}else c.show(),""==e.action&&($(".confirmbtn").hide(),$(".cartbtn").show(),$(".buybtn").show())},close:function(){c.container.close()},init:function(){$(".other-time").click(function(){$(".cyceltime").css("display","block"),$(".cyclenotime").css("display","none"),$(".cancelbtn").css("display"," table-cell")});var o=document.documentElement.clientHeight||document.body.clientHeight;$(window).on("resize",function(){if((document.documentElement.clientHeight||document.body.clientHeight)<o){var i=document.body.clientHeight;$(".fui-page.fui-page-current").css("overflow","hidden"),$(".fui-page.fui-page-current").css("height",i)}else{i=document.body.clientHeight;$(".fui-page.fui-page-current").css("overflow","auto"),$(".fui-page.fui-page-current").css("height",i)}}),$(".closebtn",c.container.container).unbind("click").click(function(){c.close()}),$(".cancelbtn",c.container.container).unbind("click").click(function(){$(".cyceltime").css("display","none"),$(".cyclenotime").css("display","block"),$(".cancelbtn").css("display"," none")}),$(".fui-mask").unbind("click").click(function(){c.close()}),0==c.seckillinfo?$(".fui-number",c.container.container).numbers({value:c.params.total,max:c.goods.maxbuy,min:c.goods.minbuy,minToast:"{min}"+c.goods.unit+"起售",maxToast:"最多购买{max}"+c.goods.unit,callback:function(i){c.params.total=i}}):c.params.total=1,$(".spec-item",c.container.container).unbind("click").click(function(){c.chooseSpec(this)}),$(".cartbtn",c.container.container).unbind("click").click(function(){c.addToCart()}),$(".gift-item").on("click",function(){$.ajax({url:n.getUrl("goods/detail/querygift",{id:$(this).val()}),cache:!0,success:function(i){0<(i=window.JSON.parse(i)).status&&(c.params.giftid=i.result.id,c.params.getgift=1)}})}),$(".buybtn",c.container.container).unbind("click").click(function(){if(!$(this).hasClass("disabled")&&c.check())if(giftid=0,1==c.params.cangift&&1==c.goods.giftinfo.length&&(giftid=c.goods.giftid),1==c.params.cangift&&null==c.params.giftid&&1<c.goods.giftinfo.length)FoxUI.toast.show("请选择赠品");else{if(null==c.params.getgift?giftid=c.goods.giftid:giftid=c.params.giftid,0<$(".diyform-container").length){var i=e.getData(".diyform-container");if(!i)return;n.json("order/create/diyform",{id:c.goods.id,diyformdata:i},function(i){location.href=n.getUrl("order/create",{id:c.goods.id,optionid:c.params.optionid,giftid:giftid,total:c.params.total,gdid:i.result.goods_data_id})},!0,!0)}else location.href=n.getUrl("order/create",{id:c.goods.id,optionid:c.params.optionid,giftid:giftid,total:c.params.total});c.params.autoClose&&c.close()}}),$(".confirmbtn",c.container.container).unbind("click").click(function(){$(this).hasClass("disabled")||c.check()&&(c.params.onConfirm&&(c.params.total=parseInt($(".num",c.container.container).val()),c.params.onConfirm(c.params.total,c.params.optionid,c.params.titles,c.params.optionthumb)),c.params.autoClose&&c.close())});var i=.6*$(document.body).height(),t=i-$(".option-picker-cell").outerHeight()-$(".option-picker .fui-navbar").outerHeight();c.container.container.find(".option-picker").css("height",i),$(".date-picker").css("height","18rem"),c.container.container.find(".option-picker .option-picker-options").css("height",t);o=document.documentElement.clientHeight||document.body.clientHeight;$(window).on("resize",function(){if((document.documentElement.clientHeight||document.body.clientHeight)<o){$(".fui-navbar").css({display:"none"}),$(".option-picker").css({height:"auto"});var i=(t=.6*$(document.body).height())-$(".option-picker-cell").outerHeight();c.container.container.find(".option-picker").css("height",t),c.container.container.find(".option-picker .option-picker-options").css("height",i),$(".option-picker").addClass("android")}else{$(".fui-navbar").css({display:"block"});var t;i=(t=.6*$(document.body).height())-$(".option-picker-cell").outerHeight()-$(".option-picker .fui-navbar").outerHeight();c.container.container.find(".option-picker").css("height",t),c.container.container.find(".option-picker .option-picker-options").css("height",i),$(".option-picker").addClass("android")}})},addToCart:function(){if(c.goods.canAddCart){if(!$(this).hasClass("disabled")&&c.check()){if(c.params.total=parseInt($(".num",c.container.container).val()),0<$(".diyform-container").length){FoxUI.loader.show("mini");var t=e.getData(".option-picker .diyform-container");if(FoxUI.loader.hide(),!t)return;require(["biz/member/cart"],function(i){i.add(c.goodsid,c.params.optionid,c.params.total,t,function(i){FoxUI.toast.show("添加成功"),c.changeCartcount(i.cartcount)})})}else require(["biz/member/cart"],function(i){i.add(c.goodsid,c.params.optionid,c.params.total,!1,function(i){FoxUI.toast.show("添加成功"),c.changeCartcount(i.cartcount)})});c.params.autoClose&&c.close()}}else FoxUI.toast.show("此商品不可加入购物车<br>请直接点击立刻购买")},show:function(){if(c.followtip)FoxUI.confirm(c.followtip,function(){""!=c.followurl&&null!=c.followurl&&(location.href=c.followurl)});else{if(c.needlogin){var t=n.getUrl("goods/detail",{id:c.goodsid});return t=t.replace("./index.php?",""),void require(["biz/member/account"],function(i){i.initQuick({action:"login",backurl:btoa(t),endtime:c.endtime,imgcode:c.imgcode,success:function(){var i=c.params;i.refresh=!0,c.open(i)}})})}if(c.mustbind)require(["biz/member/account"],function(i){i.initQuick({action:"bind",backurl:btoa(location.href),endtime:c.endtime,imgcode:c.imgcode,success:function(){var i=c.params;i.refresh=!0,c.open(i)}})});else{if(c.container=new FoxUIModal({content:c.containerHTML,extraClass:"picker-modal"}),c.init(),c.seckillinfo&&0==c.seckillinfo.status&&($(".fui-mask").hide(),$(".picker-modal").hide(),(void 0===c.options.length||c.options.length<=0)&&$(".diyform-container").length<=0)){if("buy"==c.params.action)return void(location.href=n.getUrl("order/create",{id:c.goods.id,total:1,optionid:0}));if("cart"==c.params.action)return void c.addToCart()}$(".fui-mask").show(),$(".picker-modal").show(),c.params.showConfirm?$(".confirmbtn",c.container.container).show():($(".buybtn",c.container.container).show(),c.goods.canAddCart&&$(".cartbtn",c.container.container).show()),"0"!=c.params.optionid&&c.initOption(),c.container.show(),1==c.specs.length&&$.each(c.options,function(){var i=this.specs;0==this.stock&&$(".spec-item"+i).removeClass("spec-item").removeClass("btn-danger").addClass("disabled").off("click")})}}},initOption:function(){$(".spec-item").removeClass("btn-danger");var i=c.params.optionid,o=!1;if($.each(c.options,function(){if(this.id==i)return o=this.specs.split("_"),!1}),o){var e=[];if($(".spec-item").each(function(){var i=$(this),t=i.data("id");$.each(o,function(){this==t&&(e.push(i),i.addClass("btn-danger"))})}),0<e.length){var t=e[e.length-1];c.chooseSpec(t,!1)}}},chooseSpec:function(i,t){var n=$(i);n.hasClass("btn-danger")?(n.removeClass("btn-danger"),$(".nav").removeClass("disabled").addClass("spec-item"),$(".member_discount",c.container.container).hide(),$(".spec-item",c.container.container).unbind("click").click(function(){c.chooseSpec(this)})):(n.closest(".spec").find(".spec-item").removeClass("btn-danger"),n.addClass("btn-danger"));var o=n.data("thumb")||"";o&&$(".thumb",c.container.container).attr("src",o),c.params.optionthumb=o;var s=$(".spec-item.btn-danger",c.container.container),e=[];s.length<=c.specs.length&&$.each(c.options,function(){if(c.specs.length-s.length==1){var i=[],t=this.specs;if($.each(s,function(){0<=t.indexOf(this.getAttribute("data-id"))&&i.push(this.getAttribute("data-id"))}),i.length==s.length){for(var o=0;o<i.length;o++)t=t.replace(i[o],"");t=t.split("_");var e=[];$.each(t,function(i,t){var o=$.trim(t);""!=o&&e.push(o)}),this.stock<=0&&-1!=this.stock?$(".spec-item"+e[0]).removeClass("spec-item").removeClass("btn-danger").addClass("disabled").off("click"):$(".spec-item"+e[0]).removeClass("disabled").addClass("spec-item").off("click").on("click",function(){c.chooseSpec(this)})}}else if(c.specs.length==s.length){i=[],t=this.specs;$.each(s,function(){0<=t.indexOf(this.getAttribute("data-id"))&&0<=t.indexOf(n.data("id"))&&i.push(this.getAttribute("data-id"))});e=[];if(i.length==c.specs.length-1){for(o=0;o<i.length;o++)t=t.replace(i[o],"");t=t.split("_"),$.each(t,function(i,t){var o=$.trim(t);""!=o&&e.push(o)}),this.stock<=0&&-1!=this.stock?$(".spec-item"+e[0]).removeClass("spec-item").removeClass("btn-danger").addClass("disabled").off("click"):$(".spec-item"+e[0]).removeClass("disabled").addClass("spec-item").off("click").on("click",function(){c.chooseSpec(this)})}}}),s.length==c.specs.length&&(s.each(function(){e.push($(this).data("id"))}),$.each(c.options,function(){if(this.specs.split("_").sort().join("_")==e.sort().join("_")){var i="-1"==this.stock?"无限":this.stock;$(".total",c.container.container).html(i),"-1"!=this.stock&&this.stock<=0?($(".confirmbtn",c.container).show().addClass("disabled").html("库存不足"),$(".cartbtn,.buybtn",c.container).hide()):c.params.showConfirm?($(".confirmbtn",c.container).removeClass("disabled").html("确定"),$(".cartbtn,.buybtn",c.container).hide()):($(".cartbtn,.buybtn",c.container).show(),$(".confirmbtn").hide());var t=Date.parse(new Date)/1e3;if(0!=c.seckillinfo&&t>c.seckillinfo.starttime&&t<c.seckillinfo.endtime){var o=this;$.each(c.seckillinfo.options,function(){this.optionid==o.id&&$(".price",c.container.container).html(this.price)})}else 0<c.goods.ispresell&&(0==c.goods.preselltimeend||c.goods.preselltimeend>t)?$(".price",c.container.container).html(this.presellprice):$(".price",c.container.container).html(this.marketprice);0<this.seecommission&&($(".option-Commission").addClass("show"),$(".option-Commission span",c.container.container).html(this.seecommission)),0<this.member_discount?($(".member_discount .text-danger",c.container.container).html(" ￥ "+this.member_discount),$(".member_discount",c.container.container).show(),$(".member_discount",c.container.container).css("display","inline-block")):$(".member_discount",c.container.container).hide(),c.option=this,c.params.optionid=this.id}}));var a=[];s.each(function(){a.push($.trim($(this).html()))}),c.params.titles=a.join(c.params.split),$(".info-titles",c.container.container).html("已选 "+c.params.titles),t&&c.params.onSelected&&c.params.onSelected(c.params.total,c.params.optionid,c.params.titles)},check:function(){var i=$(".spec",c.container.container),t=!0;if(i.each(function(){if($(this).find(".spec-item.btn-danger").length<=0)return FoxUI.toast.show("请选择"+$(this).find(".title").html()),t=!1}),t){if(-1!=c.option.stock&&c.option.stock<=0)return FoxUI.toast.show("库存不足"),!1;var o=parseInt($(".num",c.container.container).val());return o<=0&&(o=1),o>c.option.stock&&(o=c.option.stock),$(".num",c.container.container).val(o),0<c.goods.maxbuy&&o>c.goods.maxbuy?(FoxUI.toast.show("最多购买 "+c.goods.maxbuy+" "+c.goods.unit),!1):!(0<c.goods.minbuy&&o<c.goods.minbuy)||(FoxUI.toast.show(c.goods.minbuy+c.goods.unit+"起售"),!1)}return!1},changeCartcount:function(i){if(0<$("#menucart").length){var t=$("#menucart").find(".badge");t.length<1?$("#menucart").append('<span class="badge in">'+i+"</div>"):($(".cart-item").find(".badge").html(i).removeClass("out").addClass("in"),t.text(i))}}};return c});